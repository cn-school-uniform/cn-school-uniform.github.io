<!DOCTYPE html>
<html lang="zh">
<head>
	<meta charset="UTF-8">
	<title>中国校服地图</title>
	<script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
	<style>
		#main {
			width: 100%;
			height: 800px;
		}
		#info-card {
			position: absolute;
			top: 20px;
			right: 20px;
			width: 300px;
			padding: 10px;
			background-color: #fff;
			box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
			display: none;
		}
		#info-card img {
			max-width: 100%;
		}
		
		#image-zoom {
			position: fixed;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			background: rgba(0, 0, 0, 0.8);
			z-index: 1000;
			display: flex;
			justify-content: center;
		}
		#image-zoom img {
			max-width: 90%;
			max-height: 90%;
			cursor: pointer;
		}
	</style>
</head>
<body>
<div id="main"></div>
<div id="info-card">
	<h3 id="school-name"></h3>
	<p id="description"></p>
	<img id="school-image" src="" alt="School Image">
	<div id="image-zoom" style="display:none">
		<img id="zoomed-image" src="" alt="Zoomed Image">
	</div>
</div>

<script>
	// Fetch data from JSON file
	const chinaCitiesJson='https://unpkg.com/echarts@4.9.0/map/json/china-cities.json',
		colors = ["#009688", "#4CAF50", "#FFEB3B", "#F44336"],
		desc = ["这所学校似乎并不要求穿校服",
			"这所学校似乎要求学生每天穿校服，并且拥有漂亮的校服",
			"这所学校似乎要求学生每天穿校服，校服看上去很普通",
			"这所学校似乎要求学生每天都穿不那么好看的校服"];
	Promise.all([fetch('data.json'), fetch(chinaCitiesJson)])
		.then(response => Promise.all(response.map(r=>r.json())))
		.then(dataArray => {
			const data = dataArray[0];
			const chinaCities = dataArray[1];
			// Initialize ECharts
			echarts.registerMap("china", chinaCities);
			let chart = echarts.init($('#main')[0]);
			
			// Prepare map data
			let mapData = data.map(item => ({
				name: item.city_name,
				itemStyle: {
					areaColor: colors[item.status],
				},
				school_name: item.school_name,
				description: desc[item.status] + (item.description?"<br>"+item.description:""),
				image_path: item.image_path
			}));
			
			// Set ECharts option
			let option = {
				tooltip: {
					trigger: 'item',
					formatter: params => params.data?.school_name ?? "数据暂缺"
				},
				series: [{
					type: 'map',
					map: 'china',
					selectedMode: false, // 取消选中黄色
					data: mapData,
					emphasis: {
						itemStyle: {
							areaColor: '#a0a0a0'
						}
					}
				}]
			};
			
			chart.setOption(option);

			chart.on('click', function (params) {
				if (params.componentType === 'series') {
					let areaData = params.data;
					
					$('#school-name').text(params.name + (areaData?"："+areaData.school_name:""));
					$('#description').html(areaData?.description ?? "数据暂缺");
					let schoolImage = $('#school-image');
					if(areaData){
						schoolImage.attr("src", areaData.image_path);
						schoolImage.show();
					}else{
						schoolImage.hide();
					}

					$('#info-card').css('display', 'block');
				}
			});
			
			// 单击放大图片
			$('#school-image').on('click', ()=>{
				$('#zoomed-image').attr("src", $('#school-image').attr("src"));
				$('#image-zoom').show();
			});
			$('#image-zoom').on('click', ()=>{
				$('#image-zoom').hide();
			});
		})
		.catch(error => console.error('Error fetching data:', error));
</script>
</body>
</html>

